@page "/login"
@using Microsoft.AspNetCore.Components.Authorization
@using ProyectoFarmaVita.Models
@using ProyectoFarmaVita.Services.LoginServices
@inject ILoginService LoginService
@inject NavigationManager NavigationManager
@inject ILogger<Login> logger
@inject ISnackbar Snackbar
@inject CustomAuthenticationStateProvider customAuthenticationStateProvider
@implements IDisposable

<PageTitle>FarmaVita - Iniciar Sesión</PageTitle>

@if (!isUserAuthenticated)
{
    <div class="login-page-container">
        <div class="login-form-container">
            <div class="login-background">
                <div class="content-wrapper">
                    <div class="welcome-side">
                        <!-- CONTENIDO DE BIENVENIDA -->
                    </div>
                    <div class="login-side">
                        <div class="login-form">
                            <h2>Iniciar Sesión</h2>
                            <p class="login-subtitle">Accede a tu cuenta del sistema</p>

                            @if (!string.IsNullOrEmpty(errorMessage))
                            {
                                <MudAlert Severity="Severity.Error" Class="mb-4">@errorMessage</MudAlert>
                            }

                            <EditForm Model="@credencialesUsuario" OnValidSubmit="@HandleLogin">
                                <DataAnnotationsValidator />

                                <MudTextField Label="Correo Electrónico"
                                              @bind-Value="credencialesUsuario.Email"
                                              For="@(() => credencialesUsuario.Email)"
                                              Required="true"
                                              Variant="Variant.Outlined"
                                              FullWidth="true"
                                              Class="mb-3"
                                              Adornment="Adornment.Start"
                                              AdornmentIcon="@Icons.Material.Filled.Email"
                                              Disabled="@isLoading" />

                                <MudTextField Label="Contraseña"
                                              @bind-Value="credencialesUsuario.Password"
                                              For="@(() => credencialesUsuario.Password)"
                                              InputType="@(passwordVisible? InputType.Text: InputType.Password)"
                                              Required="true"
                                              Variant="Variant.Outlined"
                                              FullWidth="true"
                                              Adornment="Adornment.End"
                                              AdornmentIcon="@(passwordVisible? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                                              OnAdornmentClick="@TogglePasswordVisibility"
                                              Disabled="@isLoading" />

                                <MudButton ButtonType="ButtonType.Submit"
                                           Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           FullWidth="true"
                                           Size="Size.Large"
                                           Class="iniciar-sesion-button mt-4"
                                           Disabled="@isLoading">
                                    @if (isLoading)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                        <span class="ml-2">Iniciando sesión...</span>
                                    }
                                    else
                                    {
                                        <i class="fas fa-sign-in-alt mr-2"></i>
                                        <span>Iniciar Sesión</span>
                                    }
                                </MudButton>
                            </EditForm>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private CredencialesUsuario credencialesUsuario = new();
    private string errorMessage = string.Empty;
    private bool passwordVisible;
    private bool isLoading;
    private bool isUserAuthenticated;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await customAuthenticationStateProvider.GetAuthenticationStateAsync();
            isUserAuthenticated = authState.User.Identity?.IsAuthenticated ?? false;

            if (isUserAuthenticated && NavigationManager.Uri.EndsWith("/login", StringComparison.OrdinalIgnoreCase))
            {
                NavigationManager.NavigateTo("/", replace: true);
            }
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Error inicializando login component");
            errorMessage = "Error cargando el componente de login.";
        }
    }

    private void TogglePasswordVisibility()
    {
        passwordVisible = !passwordVisible;
    }

    private async Task HandleLogin()
    {
        isLoading = true;
        errorMessage = string.Empty;

        try
        {
            var respuesta = await LoginService.Login(credencialesUsuario);

            if (string.IsNullOrEmpty(respuesta?.Token))
            {
                MostrarError(respuesta?.Error ?? "Credenciales incorrectas.");
                return;
            }

            await customAuthenticationStateProvider.SetTokenAsync(respuesta.Token);

            // Re-obtener autenticación
            var authState = await customAuthenticationStateProvider.GetAuthenticationStateAsync();
            if (authState.User.Identity?.IsAuthenticated ?? false)
            {
                var userName = authState.User.FindFirst("nombre")?.Value
                             ?? authState.User.Identity?.Name
                             ?? "Usuario";

                Snackbar.Add($"¡Bienvenido, {userName}!", Severity.Success);
                NavigationManager.NavigateTo("/", replace: true);
                isUserAuthenticated = true;
            }
            else
            {
                MostrarError("Error de autenticación. Intente nuevamente.");
                await customAuthenticationStateProvider.LogoutAsync();
            }
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Error durante inicio de sesión");
            MostrarError("Ocurrió un error inesperado. Intente nuevamente.");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void MostrarError(string mensaje)
    {
        errorMessage = mensaje;
        Snackbar.Add(errorMessage, Severity.Error);
    }

    public void Dispose() { }
}
